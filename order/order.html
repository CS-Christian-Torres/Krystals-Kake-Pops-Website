<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order | Krystalâ€™s Kake Pops</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"/>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="order.css" />

  <!-- HelcimPay.js Library -->
<script src="https://api.helcim.com/helcim-pay.js"></script>

</head>
<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container px-3">
      <a class="navbar-brand d-flex align-items-center" href="../index.html">
        <img
          src="../gallery/logo.png"
          width="50"
          height="50"
          class="logo-circle me-2"
          alt="Krystal's Kake Pops logo"
        />
        <span class="fw-bold text-danger">Krystal's Kake Pops</span>
      </a>

      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="../menu/menu.html">Menu</a></li>
          <li class="nav-item">
            <a class="nav-link" href="../index.html#contact">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container my-5">
    <!-- âš ï¸ Delivery / Pickup Notice -->
    <div
      class="alert alert-warning text-center shadow-sm mb-4 rounded-3"
      role="alert"
    >
      <strong>Important:</strong> Krystalâ€™s Kake Pops is a home-based bakery.<br />
      We coordinate pickup or delivery directly after your order is placed.<br /><br />
      ğŸ  <strong>Pickup:</strong> By appointment only (address shared after confirmation).<br />
      ğŸš— <strong>Delivery:</strong> Free for <em>6 or more items</em> in
      <b>Oâ€™Fallon</b>, <b>Shiloh</b>, and <b>Fairview Heights</b>.<br />
      ğŸ“ Please contact us at
      <a
        href="tel:+1YOURNUMBER"
        class="fw-bold text-danger text-decoration-none"
        >YOUR PHONE NUMBER</a
      >
      after placing your order to arrange pickup or delivery.
    </div>

    <!-- Pricing Info Banner -->
    <div
      class="alert alert-light border rounded-3 mb-4 text-center shadow-sm"
      role="alert"
      style="background-color: #fff5f5"
    >
      <strong>ğŸ’² Bundle Pricing â€” Chocolate & Vanilla only:</strong><br />
      Applies to <em>ğŸ« Chocolate Bliss</em> and <em>âœ¨ Vanilla Dream</em> (mix &
      match).<br />
      1 for <strong>$3.50</strong> â€¢ 3 for <strong>$8.75</strong> â€¢ Â½ dozen (6)
      for <strong>$16</strong> â€¢ 1 dozen (12) for <strong>$27</strong><br />
      <span class="text-muted small"
        >ğŸª Klassic Kookie Krush, ğŸ¥¨ Chocolate Drizzle Krunch, ğŸ¬ Rice Krispy
        Cloud, and ğŸª Cookies & Cream Dream are single-item pricing only.</span
      >
    </div>

    <!-- Order Card -->
    <div class="card border-0 shadow-sm p-3 p-md-4 mb-4">
      <h3 class="text-center text-danger fw-bold mb-4">Place Your Order</h3>

      <!-- Responsive Table -->
      <div class="table-responsive">
        <table class="table align-middle text-center mb-0">
          <thead class="table-light">
            <tr>
              <th>Item</th>
              <th style="width: 90px">Qty</th>
              <th>Price</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody>
            <!-- Chocolate Bliss -->
            <tr class="individual">
              <td class="product-name">ğŸ« Chocolate Bliss</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$3.50</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <!-- Vanilla Dream -->
            <tr class="individual">
              <td class="product-name">âœ¨ Vanilla Dream</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$3.50</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <!-- Single-item -->
            <tr class="individual">
              <td class="product-name">ğŸª Klassic Kookie Krush</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$2.50</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <tr class="individual">
              <td class="product-name">ğŸ¥¨ Chocolate Drizzle Krunch</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$2.50</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <tr class="individual">
              <td class="product-name">ğŸ¬ Rice Krispy Cloud</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$2.50</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <tr class="individual">
              <td class="product-name">ğŸª Cookies & Cream Dream</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$2.50</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <!-- Dozen-only items -->
            <tr class="dozen">
              <td class="product-name">ğŸ“ Strawberry Burst</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$27 / dozen</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <tr class="dozen">
              <td class="product-name">ğŸ‹ Lemon Poppy Delight</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$27 / dozen</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <tr class="dozen">
              <td class="product-name">â¤ï¸ Red Velvet Romance</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$27 / dozen</td>
              <td class="subtotal">$0.00</td>
            </tr>

            <tr class="dozen">
              <td class="product-name">ğŸƒ Spooky Skull Pop</td>
              <td>
                <input
                  type="number"
                  class="qty-input form-control form-control-sm text-center mx-auto"
                  min="0"
                  step="1"
                  value="0"
                  style="max-width: 70px"
                />
              </td>
              <td class="price">$27 / dozen</td>
              <td class="subtotal">$0.00</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Total + Button -->
      <div class="text-center mt-4">
        <h4 class="fw-bold text-danger">
          Total: <span id="orderTotal">$0.00</span>
        </h4>
        <p class="text-muted small mb-3">
          ğŸ’³ Online payments only. Cash orders must be placed by phone.
        </p>
    <button
      type="button"
      class="btn btn-danger px-4 py-2 rounded-pill shadow-sm w-100 w-md-auto"
      onclick="processPayment()"
    >
      ğŸ’³ Proceed to Payment â†’
    </button>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/order/order.js"></script>


  <!-- HelcimPay Integration -->
<script>
async function processPayment() {
  const totalElement = document.getElementById("orderTotal");
  const amount = parseFloat(totalElement.textContent.replace("$", "")) || 0;

  if (amount <= 0) {
    alert("Please select at least one item before proceeding to payment.");
    return;
  }

  // ğŸ“ Description (optional: you can make this more detailed)
  const description = `Krystalâ€™s Kake Pops Order - Total $${amount.toFixed(2)}`;

  // ğŸ§¾ Notify user
  const button = document.querySelector("button.btn-danger");
  button.disabled = true;
  button.textContent = "Processing...";

  try {
    // ğŸ” Request checkout session from your Flask API
    const response = await fetch("https://api.krystalskakepops.com/helcim-session", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: amount.toFixed(2), description }),
    });

    const data = await response.json();
    console.log("[Helcim Response]", data);

    if (data.checkoutToken) {
      // ğŸ‰ Open Helcim payment modal
      appendHelcimPayIframe(data.checkoutToken);
      button.textContent = "Opening Payment...";
    } else {
      alert("Payment session could not be created: " + (data.error || "Unknown error"));
      button.textContent = "ğŸ’³ Proceed to Payment â†’";
    }
  } catch (err) {
    console.error(err);
    alert("There was a problem connecting to the payment server.");
    button.textContent = "ğŸ’³ Proceed to Payment â†’";
  } finally {
    button.disabled = false;
  }
}

// âœ… Listen for HelcimPay responses
window.addEventListener("message", (event) => {
  if (!event.data?.eventName) return;

  const status = event.data?.eventStatus;
  if (status === "SUCCESS") {
    alert("âœ… Payment successful! Thank you for your order!");
  } else if (status === "ABORTED") {
    alert("âŒ Payment canceled.");
  }
});
</script>

</body>
</html>
